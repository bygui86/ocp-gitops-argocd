apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  labels:
{{ include "springboot-tekton.labels" . | nindent 4 }}
  name: deploy
spec:
  workspaces:
    - name: output-area
  params:
    - description: The namespace we are tagging to
      name: toNamespace
      type: string
    - description: The image tag
      name: tag
      type: string
      default: latest
    - description: the deployment
      name: deployment-folder
      type: string
      default: manifests
  resources:
    inputs:
      - name: gitops-repo
        type: git
  steps:
  - name: yq-version-update
    image: clamer/kikd:1.0.2
    workingDir: /workspace/gitops-repo
    script: |
      yq write -i $(params.deployment-folder)/deployment.yml \
        "spec.template.spec.containers[0].image" \
        {{.Values.fullnameOverride}}:"$(cat /workspace/output-area/version)"

  - name: whoami
    image: clamer/kikd:1.0.2
    workingDir: /workspace/gitops-repo
    securityContext:
      privileged: true
    script: |
      whoami
      
#git commit -am 'msg' 

  #   git config --global user.email "you@example.com"
  # git config --global user.name "Your Name"

  # - name: git-push-repo
  #   image: clamer/kikd:1.0.2
  #   workingDir: /workspace/gitops-repo
  #   script: |
  #     cp -r /tekton/home/.ssh /root/ && \
  #     git push origin master